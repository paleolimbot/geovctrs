<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending geovctrs • geovctrs</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending geovctrs">
<meta property="og:description" content="geovctrs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geovctrs</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/extending-geovctrs.html">Extending geovctrs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/paleolimbot/geovctrs/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extending geovctrs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/paleolimbot/geovctrs/blob/master/vignettes/extending-geovctrs.Rmd"><code>vignettes/extending-geovctrs.Rmd</code></a></small>
      <div class="hidden name"><code>extending-geovctrs.Rmd</code></div>

    </div>

    
    
<p>The geovctrs package was designed from the ground up to be extensible. The package itself does little, but provides S3 classes and generics you can use to make processing functions and/or geometry classes that “just work” with the tidyverse and other geometry packages. There are three types of extensibility covered in this vignette: extracting functions, transforming functions, and new geometry classes.</p>
<p>To start, we’ll load the package and define a vector of geometries to use as examples.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">geovctrs</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tibble</span>)

<span class="no">geometries</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/geo_wkt.html">geo_wkt</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"POINT (0 0)"</span>,
    <span class="st">"LINESTRING (10 12, -11 2)"</span>,
    <span class="st">"POLYGON ((-5 -5, 5 -5, 5 5, -5 5, -5 -5))"</span>
  )
)

<span class="fu"><a href="../reference/geo_plot.html">geo_plot</a></span>(<span class="no">geometries</span>)</pre></body></html></div>
<p><img src="extending-geovctrs_files/figure-html/setup-1.png" width="700"></p>
<div id="extracting-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#extracting-functions" class="anchor"></a>Extracting functions</h2>
<p>Extracting functions take a vector of geometries and provide some kind of information for each feature. Examples from the geovctrs package include <code><a href="../reference/geo_summary.html">geo_n_coordinates()</a></code>, <code><a href="../reference/geo_summary.html">geo_geometry_type()</a></code>, and <code><a href="../reference/geo_summary.html">geo_summary()</a></code>: all of these take a vector of geometries and return a vector of the same size as the input (note that the “size” of a data frame is the number of rows, after <code><a href="https://rdrr.io/pkg/vctrs/man/vec_size.html">vctrs::vec_size()</a></code>).</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="../reference/geo_summary.html">geo_n_coordinates</a></span>(<span class="no">geometries</span>)
<span class="co">#&gt; [1] 1 2 5</span>
<span class="fu"><a href="../reference/geo_summary.html">geo_geometry_type</a></span>(<span class="no">geometries</span>)
<span class="co">#&gt; [1] "point"      "linestring" "polygon"</span>
<span class="fu"><a href="../reference/geo_summary.html">geo_summary</a></span>(<span class="no">geometries</span>)
<span class="co">#&gt; # A tibble: 3 x 7</span>
<span class="co">#&gt;   geometry_type is_empty n_coordinates n_geometries  srid coordinate_dime…</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;lgl&gt;            &lt;int&gt;        &lt;int&gt; &lt;int&gt;            &lt;int&gt;</span>
<span class="co">#&gt; 1 point         FALSE                1            1     0                2</span>
<span class="co">#&gt; 2 linestring    FALSE                2            1     0                2</span>
<span class="co">#&gt; 3 polygon       FALSE                5            1     0                2</span>
<span class="co">#&gt; # … with 1 more variable: first_coordinate &lt;xy&gt;</span></pre></body></html></div>
<p>All of these functions work with a variety of data types: it doesn’t matter whether you have a character vector, a geovctr, or a data frame with a geometry column, the function knows to coerce the input to a geovctr by default:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/geo_summary.html">geo_n_coordinates</a></span>(<span class="fu"><a href="../reference/geo_wkt.html">geo_wkt</a></span>(<span class="st">"POINT EMPTY"</span>))
<span class="co">#&gt; [1] 0</span>
<span class="fu"><a href="../reference/geo_summary.html">geo_n_coordinates</a></span>(<span class="st">"POINT EMPTY"</span>)
<span class="co">#&gt; [1] 0</span>
<span class="fu"><a href="../reference/geo_summary.html">geo_n_coordinates</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="kw">geom</span> <span class="kw">=</span> <span class="fu"><a href="../reference/geo_wkt.html">geo_wkt</a></span>(<span class="st">"POINT EMPTY"</span>)))
<span class="co">#&gt; [1] 0</span></pre></body></html></div>
<p>This magic happens because the geovctrs package provides <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code> implementations for character vectors and data frames, and because the <code><a href="../reference/geo_summary.html">geo_n_coordinates()</a></code> is a generic that calls <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code> in its default implementation. Following this pattern, if you would like to make an extracting function that works on any geometry type, all you need to do is call <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code> in your default implementation:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">is_linestring</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span>(<span class="st">"is_linestring"</span>)
}

<span class="no">is_linestring.default</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu">is_linestring</span>(<span class="fu"><a href="../reference/is_geovctr.html">as_geovctr</a></span>(<span class="no">x</span>))
}

<span class="no">is_linestring.geovctr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="../reference/geo_summary.html">geo_geometry_type</a></span>(<span class="no">x</span>) <span class="kw">==</span> <span class="st">"linestring"</span>
}</pre></body></html></div>
<p>Here, <code>is_linestring()</code> will work on all the types supported by <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu">is_linestring</span>(<span class="no">geometries</span>) <span class="co"># geovctr_wkt/geovctr</span>
<span class="co">#&gt; [1] FALSE  TRUE FALSE</span>
<span class="fu">is_linestring</span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">geometries</span>)) <span class="co"># character</span>
<span class="co">#&gt; [1] FALSE  TRUE FALSE</span>
<span class="fu">is_linestring</span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="no">geometries</span>)) <span class="co"># data.frame</span>
<span class="co">#&gt; [1] FALSE  TRUE FALSE</span></pre></body></html></div>
<p>All extractors in the geovctrs package follow this pattern, usually providing a C++ function that works with well-known binary and faster implementations for the simpler geometry types. For example, in this case, we know that a <code><a href="../reference/geo_segment.html">geo_segment()</a></code> will always be a linestring, but a <code><a href="../reference/geo_xy.html">geo_xy()</a></code> and a <code><a href="../reference/geo_rect.html">geo_rect()</a></code> will never be:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">is_linestring.geovctrs_segment</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span>(<span class="fl">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>))
}

<span class="no">is_linestring.geovctrs_xy</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span>(<span class="fl">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>))
}

<span class="no">is_linestring.geovctrs_rect</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span>(<span class="fl">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>))
}

<span class="fu">is_linestring</span>(<span class="fu"><a href="../reference/geo_segment.html">geo_segment</a></span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">0</span>, <span class="fl">0</span>), <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">1</span>, <span class="fl">1</span>)))
<span class="co">#&gt; [1] TRUE</span>
<span class="fu">is_linestring</span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">0</span>, <span class="fl">0</span>))
<span class="co">#&gt; [1] FALSE</span>
<span class="fu">is_linestring</span>(<span class="fu"><a href="../reference/geo_rect.html">geo_rect</a></span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>))
<span class="co">#&gt; [1] FALSE</span></pre></body></html></div>
<p>For well-known text, a regular expression can often be a fast approximation of the default method. Here, a linestring will always match the regular expression <code>^\s*LINESTRING</code> (a string starting with LINESTRING with an optional amount of whitespace at the beginning). Thus, we can implement a fast version of <code>is_linestring()</code> for well-known text:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">is_linestring.geovctrs_wkt</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"^\\s*LINESTRING"</span>, <span class="no">x</span>)
}

<span class="fu">is_linestring</span>(<span class="no">geometries</span>)
<span class="co">#&gt; [1] FALSE  TRUE FALSE</span></pre></body></html></div>
<p>Most extracting functions in geovctrs do this as well: implement faster S3 generics for the simple geometries, with default method that works on any geovctr (usually implemented in C++).</p>
</div>
<div id="transforming-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#transforming-functions" class="anchor"></a>Transforming functions</h2>
<p>Transforming functions take a geometry vector and return a geometry vector of the same size. Examples from the geovctrs package include <code><a href="../reference/geo_bbox.html">geo_envelope()</a></code> (which returns the feature-specific bounding box) and <code><a href="../reference/geo_summary.html">geo_first_coordinate()</a></code>. Similar to the extracting functions, both of these accept any object that can be coerced to a geovctr using <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code>:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="../reference/geo_bbox.html">geo_envelope</a></span>(<span class="no">geometries</span>) <span class="co"># geovctr_wkt/geovctr</span>
<span class="co">#&gt; &lt;geovctrs_rect[3]&gt;</span>
<span class="co">#&gt; [1] (0 0↗0 0)     (-11 2↗10 12) (-5 -5↗5 5)</span>
<span class="fu"><a href="../reference/geo_bbox.html">geo_envelope</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">geometries</span>)) <span class="co"># character</span>
<span class="co">#&gt; &lt;geovctrs_rect[3]&gt;</span>
<span class="co">#&gt; [1] (0 0↗0 0)     (-11 2↗10 12) (-5 -5↗5 5)</span>
<span class="fu"><a href="../reference/geo_bbox.html">geo_envelope</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="kw">geom</span> <span class="kw">=</span> <span class="no">geometries</span>)) <span class="co"># data.frame</span>
<span class="co">#&gt; # A tibble: 3 x 1</span>
<span class="co">#&gt;   geom        </span>
<span class="co">#&gt;   &lt;rect&gt;      </span>
<span class="co">#&gt; 1 △ (0 0)…+4  </span>
<span class="co">#&gt; 2 △ (-11 2)…+4</span>
<span class="co">#&gt; 3 △ (-5 -5)…+4</span></pre></body></html></div>
<p>There’s a few things here that are different than extracting functions. First, transformers called on a geovctr can return any geometry vector that is also a geovctr. In this case, that means that we get back a <code><a href="../reference/geo_rect.html">geo_rect()</a></code> no matter what type of geovctr we give <code><a href="../reference/geo_bbox.html">geo_envelope()</a></code>. The casting and concatenation rules implemented in geovctrs (primarily by means of <code><a href="https://rdrr.io/pkg/vctrs/man/vec_cast.html">vctrs::vec_cast()</a></code> and <code><a href="https://rdrr.io/pkg/vctrs/man/vec_ptype2.html">vctrs::vec_ptype2()</a></code>) mean that these vectors can be used interchangeably. Transformers in geovctrs always return the simplest geometry type possible, which for envelopes and bounding boxes means a <code><a href="../reference/geo_rect.html">geo_rect()</a></code>.</p>
<p>Second, transformers try to maintain the original data structure. For data frames with exactly one geovctr column, this means that <code><a href="../reference/geo_bbox.html">geo_envelope()</a></code> returns a data frame with the geometry column replaced (again, with any type of geovctr). This magic happens by way of the <code><a href="../reference/is_geovctr.html">restore_geovctr()</a></code> generic, which is called with the initial object and the result of the transformation (this is how the geovctrs package is able to mostly support the sf package out of box).</p>
<p>Following this pattern, if you were to implement a <code>centroid()</code> function (returning the middle of the envelope), you could make it work in the same way by implementing a set of generics:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">centroid</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span>(<span class="st">"centroid"</span>)
}

<span class="no">centroid.default</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">centroid</span>(<span class="fu"><a href="../reference/is_geovctr.html">as_geovctr</a></span>(<span class="no">x</span>))
  <span class="fu"><a href="../reference/is_geovctr.html">restore_geovctr</a></span>(<span class="no">x</span>, <span class="no">result</span>)
}

<span class="no">centroid.geovctr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="no">envelope_tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>(<span class="fu"><a href="../reference/geo_bbox.html">geo_envelope</a></span>(<span class="no">x</span>))
  <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(
    (<span class="no">envelope_tbl</span>$<span class="no">xmax</span> + <span class="no">envelope_tbl</span>$<span class="no">xmin</span>) / <span class="fl">2</span>,
    (<span class="no">envelope_tbl</span>$<span class="no">ymax</span> + <span class="no">envelope_tbl</span>$<span class="no">ymin</span>) / <span class="fl">2</span>
  )
}</pre></body></html></div>
<p>Here, <code>centroid()</code> will work on all the types supported by <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code>:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu">centroid</span>(<span class="no">geometries</span>) <span class="co"># geovctr_wkt/geovctr</span>
<span class="co">#&gt; &lt;geovctrs_xy[3]&gt;</span>
<span class="co">#&gt; [1] (0.0 0)  (-0.5 7) (0.0 0)</span>
<span class="fu">centroid</span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">geometries</span>)) <span class="co"># character</span>
<span class="co">#&gt; &lt;geovctrs_xy[3]&gt;</span>
<span class="co">#&gt; [1] (0.0 0)  (-0.5 7) (0.0 0)</span>
<span class="fu">centroid</span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="kw">geom</span> <span class="kw">=</span> <span class="no">geometries</span>)) <span class="co"># data.frame</span>
<span class="co">#&gt; # A tibble: 3 x 1</span>
<span class="co">#&gt;   geom      </span>
<span class="co">#&gt;   &lt;xy&gt;      </span>
<span class="co">#&gt; 1 · (0.0 0) </span>
<span class="co">#&gt; 2 · (-0.5 7)</span>
<span class="co">#&gt; 3 · (0.0 0)</span></pre></body></html></div>
</div>
<div id="new-geometry-vector-classes" class="section level2">
<h2 class="hasAnchor">
<a href="#new-geometry-vector-classes" class="anchor"></a>New geometry vector classes</h2>
<p>The geovctrs package provides three “generic” geometry vector classes (<code><a href="../reference/geo_wkt.html">geo_wkt()</a></code>, <code><a href="../reference/geo_wkb.html">geo_wkb()</a></code>, and <code><a href="../reference/geo_collection.html">geo_collection()</a></code> can represent any feature) and three simple geometry vector classes (<code><a href="../reference/geo_xy.html">geo_xy()</a></code>, <code><a href="../reference/geo_segment.html">geo_segment()</a></code>, and <code><a href="../reference/geo_rect.html">geo_rect()</a></code> are all efficient representations of specific features). To make a new type of vector work with geovctrs functions, you can either (1) implement <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code> and (optionally) <code><a href="../reference/is_geovctr.html">restore_geovctr()</a></code>, or (2) go all-out and implement your class as a <a href="https://vctrs.r-lib.org/">vctrs</a> class that inherits from <code>"geovctr"</code>.</p>
<div id="the-easy-way" class="section level3">
<h3 class="hasAnchor">
<a href="#the-easy-way" class="anchor"></a>The easy way</h3>
<p>As an example, consider a class that represents a vector of circles. Circles can be parameterized by their center and their radius, whereas generic geometry types would need to store a large number of coordinates. A simple class based on vctrs would look like this:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">vctrs</span>)

<span class="co"># base constructor for developers</span>
<span class="no">new_circle</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">center</span> <span class="kw">=</span> <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(), <span class="kw">radius</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>()),
                       <span class="no">detail</span> <span class="kw">=</span> <span class="fl">50L</span>) {
  <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_assert.html">vec_assert</a></span>(<span class="no">x</span>$<span class="no">center</span>, <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>())
  <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_assert.html">vec_assert</a></span>(<span class="no">x</span>$<span class="no">radius</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>())
  <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_assert.html">vec_assert</a></span>(<span class="no">detail</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span>())

  <span class="kw pkg">vctrs</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/new_rcrd.html">new_rcrd</a></span>(<span class="no">x</span>, <span class="kw">class</span> <span class="kw">=</span> <span class="st">"circle"</span>, <span class="kw">detail</span> <span class="kw">=</span> <span class="no">detail</span>)
}

<span class="co"># convenient constructor for users</span>
<span class="no">circle</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">center</span> <span class="kw">=</span> <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(), <span class="no">radius</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>(), <span class="no">detail</span> <span class="kw">=</span> <span class="fl">50</span>) {
  <span class="fu">new_circle</span>(
    <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_recycle.html">vec_recycle_common</a></span>(
      <span class="kw">center</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_cast.html">vec_cast</a></span>(<span class="no">center</span>, <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>()),
      <span class="kw">radius</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_cast.html">vec_cast</a></span>(<span class="no">radius</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>()),
    ),
    <span class="kw">detail</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_cast.html">vec_cast</a></span>(<span class="no">detail</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span>())
  )
}

<span class="co"># rcrd vectors require a format method</span>
<span class="no">format.circle</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">...</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"&lt;circle: %s-&gt;%s&gt;"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/fields.html">field</a></span>(<span class="no">x</span>, <span class="st">"center"</span>)), <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/fields.html">field</a></span>(<span class="no">x</span>, <span class="st">"radius"</span>))
}

<span class="co"># create a vector of circles</span>
<span class="no">circles</span> <span class="kw">&lt;-</span> <span class="fu">circle</span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">2</span>, <span class="fl">2</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>))</pre></body></html></div>
<p>Now we have a vector that stores circle information, but to do anything useful we have to implement a function that turns each circle into a set of coordinates. Recalling your pre-calculus class, you could do so for a single circle like so:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">circle_coordinates</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">center</span>, <span class="no">radius</span>, <span class="no">detail</span> <span class="kw">=</span> <span class="fl">50</span>) {
  <span class="no">angles</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">2</span> * <span class="no">pi</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="no">detail</span>)
  <span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(
    <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/fields.html">field</a></span>(<span class="no">center</span>, <span class="st">"x"</span>) + <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span>(<span class="no">angles</span>) * <span class="no">radius</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/fields.html">field</a></span>(<span class="no">center</span>, <span class="st">"y"</span>) + <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(<span class="no">angles</span>) * <span class="no">radius</span>
  )
}

<span class="fu">circle_coordinates</span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">1</span>, <span class="fl">1</span>), <span class="fl">2</span>)
<span class="co">#&gt; &lt;geovctrs_xy[50]&gt;</span>
<span class="co">#&gt;  [1] (3.00000000 1.0000000)   (2.98358003 1.2557543)   (2.93458973 1.5073092)  </span>
<span class="co">#&gt;  [4] (2.85383351 1.7505340)   (2.74263741 1.9814351)   (2.60282724 2.1962211)  </span>
<span class="co">#&gt;  [7] (2.43669870 2.3913651)   (2.24697960 2.5636630)   (2.03678514 2.7102855)  </span>
<span class="co">#&gt; [10] (1.80956669 2.8288252)   (1.56905517 2.9173357)   (1.31919979 2.9743636)  </span>
<span class="co">#&gt; [13] (1.06410316 2.9989724)   (0.80795395 2.9907582)   (0.55495813 2.9498558)  </span>
<span class="co">#&gt; [16] (0.30926989 2.8769368)   (0.07492342 2.7731986)   (-0.14423332 2.6403445) </span>
<span class="co">#&gt; [19] (-0.34460178 2.4805560)  (-0.52289192 2.2964568)  (-0.67617621 2.0910698) </span>
<span class="co">#&gt; [22] (-0.80193774 1.8677675)  (-0.89811149 1.6302164)  (-0.96311831 1.3823173) </span>
<span class="co">#&gt; [25] (-0.99589079 1.1281404)  (-0.99589079 0.8718596)  (-0.96311831 0.6176827) </span>
<span class="co">#&gt; [28] (-0.89811149 0.3697836)  (-0.80193774 0.1322325)  (-0.67617621 -0.0910698)</span>
<span class="co">#&gt; [31] (-0.52289192 -0.2964568) (-0.34460178 -0.4805560) (-0.14423332 -0.6403445)</span>
<span class="co">#&gt; [34] (0.07492342 -0.7731986)  (0.30926989 -0.8769368)  (0.55495813 -0.9498558) </span>
<span class="co">#&gt; [37] (0.80795395 -0.9907582)  (1.06410316 -0.9989724)  (1.31919979 -0.9743636) </span>
<span class="co">#&gt; [40] (1.56905517 -0.9173357)  (1.80956669 -0.8288252)  (2.03678514 -0.7102855) </span>
<span class="co">#&gt; [43] (2.24697960 -0.5636630)  (2.43669870 -0.3913651)  (2.60282724 -0.1962211) </span>
<span class="co">#&gt; [46] (2.74263741 0.0185649)   (2.85383351 0.2494660)   (2.93458973 0.4926908)  </span>
<span class="co">#&gt; [49] (2.98358003 0.7442457)   (3.00000000 1.0000000)</span></pre></body></html></div>
<p>The easiest way to construct a geovctr is using the <code><a href="../reference/geo_collection.html">geo_collection()</a></code> family of functions, all of which take coordinates and return a geometry vector. For a single circle, we could construct polygons like so:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">circle_polygon</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">center</span>, <span class="no">radius</span>, <span class="no">detail</span> <span class="kw">=</span> <span class="fl">50</span>) {
  <span class="co"># first and last coord must be identical</span>
  <span class="no">coords</span> <span class="kw">&lt;-</span> <span class="fu">circle_coordinates</span>(<span class="no">center</span>, <span class="no">radius</span>, <span class="no">detail</span>)
  <span class="fu"><a href="../reference/geo_collection.html">geo_polygon</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">coords</span>, <span class="no">coords</span>[<span class="fl">1</span>]))
}

<span class="fu">circle_polygon</span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">1</span>, <span class="fl">1</span>), <span class="fl">2</span>)
<span class="co">#&gt; &lt;geovctrs_collection[1]&gt;</span>
<span class="co">#&gt; [1] POLYGON (3 1)…+50</span></pre></body></html></div>
<p>To turn our vector of circles into a geovctr of the same length, we can implement <code><a href="../reference/is_geovctr.html">as_geovctr()</a></code>:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">as_geovctr.circle</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">...</span>) {
  <span class="no">x_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_data.html">vec_data</a></span>(<span class="no">x</span>)
  <span class="no">features</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_size.html">vec_size</a></span>(<span class="no">x</span>)),
    <span class="kw">function</span>(<span class="no">i</span>) <span class="fu">circle_polygon</span>(
      <span class="no">x_data</span>$<span class="no">center</span>[<span class="no">i</span>],
      <span class="no">x_data</span>$<span class="no">radius</span>[<span class="no">i</span>],
      <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">x</span>, <span class="st">"detail"</span>)
    )
  )

  <span class="fu"><a href="https://rdrr.io/pkg/vctrs/man/vec_c.html">vec_c</a></span>(!!!<span class="no">features</span>)
}

<span class="no">circles</span> <span class="kw">&lt;-</span> <span class="fu">circle</span>(<span class="fu"><a href="../reference/geo_xy.html">geo_xy</a></span>(<span class="fl">2</span>, <span class="fl">2</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>))
<span class="fu"><a href="../reference/is_geovctr.html">as_geovctr</a></span>(<span class="no">circles</span>)
<span class="co">#&gt; &lt;geovctrs_collection[3]&gt;</span>
<span class="co">#&gt; [1] POLYGON (2.5 2)…+50 POLYGON (3.0 2)…+50 POLYGON (4.0 2)…+50</span></pre></body></html></div>
<p>Now, the <code>circles</code> vector works with geovctrs functions!</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/geo_bbox.html">geo_envelope</a></span>(<span class="no">circles</span>)
<span class="co">#&gt; &lt;geovctrs_rect[3]&gt;</span>
<span class="co">#&gt; [1] (1.501027304 1.500256892↗2.5 2.499743)</span>
<span class="co">#&gt; [2] (1.002054607 1.000513784↗3.0 2.999486)</span>
<span class="co">#&gt; [3] (0.004109214 0.001027568↗4.0 3.998972)</span>
<span class="fu"><a href="../reference/geo_plot.html">geo_plot</a></span>(<span class="no">circles</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">3</span>)</pre></body></html></div>
<p><img src="extending-geovctrs_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div id="the-hard-way" class="section level3">
<h3 class="hasAnchor">
<a href="#the-hard-way" class="anchor"></a>The hard way</h3>
<p>The hard way to make a vectorized geometry class is to make a full <code><a href="https://rdrr.io/pkg/vctrs/man/vec_cast.html">vctrs::vec_cast()</a></code> and <code><a href="https://rdrr.io/pkg/vctrs/man/vec_ptype2.html">vctrs::vec_ptype2()</a></code> implementation that ensures your class can be casted to the other generic geometry types. This is outside the scope of this vignette, but you may find the <code><a href="../reference/is_geovctr.html">expect_geovctr()</a></code> function and <code><a href="https://cran.rstudio.com/web/packages/vctrs/vignettes/s3-vector.html">vignette("s3-vector", package = "vctrs")</a></code> useful. The main advantage of a full vctrs implementation is that users will be able to combine your class with other geometry vectors in a <code>dplyr::bind_rows()</code> operation (or similar).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dewey Dunnington.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
